# Sitemap Diff - 项目文档

## 项目概述
监控多个网站的 sitemap，检测新增 URL，并通过 Discord/Telegram 发送通知。

## 架构 (V2.0)

```
┌─────────────────────┐     ┌─────────────────┐
│  GitHub Actions     │────▶│  Supabase       │
│  (定时检查 sitemap) │     │  (数据存储)      │
└─────────┬───────────┘     └────────┬────────┘
          │                          │
          ▼                          │
┌─────────────────────┐              │
│ Discord/Telegram    │              │
│ (发送通知)          │              │
└─────────────────────┘              │
                                     │
┌─────────────────────┐              │
│  Vercel API         │◀─────────────┘
│  (Discord 命令)     │
└─────────────────────┘
```

### 组件说明
- **GitHub Actions**: 每 8 小时定时执行 sitemap 检查，无 CPU 限制
- **Supabase**: 存储订阅源、sitemap 内容、更新日志
- **Vercel**: 处理 Discord 斜杠命令 (/rss, /status)
- **Discord/Telegram**: 接收通知和发送命令

## 目录结构

```
sitemap-diff/
├── lib/                      # 核心库
│   ├── supabase.js           # Supabase 客户端
│   ├── rss-manager.js        # RSS 管理器
│   └── check-sitemaps.js     # 定时检查脚本
├── api/                      # Vercel API 端点
│   ├── discord.js            # Discord webhook
│   └── health.js             # 健康检查
├── supabase/
│   └── schema.sql            # 数据库表结构
├── .github/workflows/
│   └── check-sitemaps.yml    # GitHub Actions
├── vercel.json               # Vercel 配置
└── package.json
```

## 环境变量

### GitHub Actions Secrets
- `SUPABASE_URL` - Supabase 项目 URL
- `SUPABASE_SERVICE_KEY` - Supabase 服务密钥
- `DISCORD_TOKEN` - Discord Bot Token
- `DISCORD_CHANNEL_ID` - Discord 通知频道 ID
- `TELEGRAM_BOT_TOKEN` - Telegram Bot Token
- `TELEGRAM_TARGET_CHAT` - Telegram 目标群组 ID

### Vercel Environment Variables
- `SUPABASE_URL`
- `SUPABASE_SERVICE_KEY`
- `DISCORD_PUBLIC_KEY` - Discord 应用公钥（用于签名验证）

## Discord 命令

| 命令 | 说明 |
|------|------|
| `/rss list` | 显示所有监控的 sitemap |
| `/rss add <url>` | 添加 sitemap 监控 |
| `/rss del <url>` | 删除 sitemap 监控 |
| `/status` | 查看 Bot 运行状态 |
| `/news` | 提示手动触发 GitHub Actions |

## 部署步骤

### 1. 创建 Supabase 项目
1. 在 Supabase 创建新项目
2. 执行 `supabase/schema.sql` 创建表

### 2. 部署 Vercel
```bash
npm install
vercel deploy --prod
```
设置环境变量：SUPABASE_URL, SUPABASE_SERVICE_KEY, DISCORD_PUBLIC_KEY

### 3. 配置 GitHub Actions
在仓库 Settings > Secrets 添加所有环境变量

### 4. 配置 Discord
1. 在 Discord Developer Portal 设置 Interactions Endpoint URL：
   `https://your-project.vercel.app/webhook/discord`
2. 注册斜杠命令（使用 Discord API）

## 开发命令

```bash
npm run check    # 本地运行 sitemap 检查
npm run dev      # 本地开发 Vercel API
npm run deploy   # 部署到 Vercel
```
